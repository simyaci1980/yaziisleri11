{% extends 'layout.html' %}
{% load static %}

{% block content %}

<div class="container mt-5">

    <!-- Başlık ve açıklama -->
    <div class="text-center mb-4">
        <h1>Yazı İşleri Müdürlüğü Notları</h1>
        <p>Türkiye’de sınava hazırlananlar için hazırlanmış notlar ve rehber içerikler.</p>
    </div>

    <!-- Chat Kutusu -->
    <div id="chat-container" class="border rounded p-3 mb-4" style="background:#fafafa;">
        <div id="chat-box" style="height:300px; overflow-y:auto; margin-bottom:10px;">
            <p><em>Merhaba! Sorularınızı buradan iletebilirsiniz.</em></p>
        </div>
        <form id="chat-form" style="display:flex;">
            <input type="text" id="chat-input" class="form-control me-2" placeholder="Mesajınızı yazın...">
            <button type="submit" class="btn btn-primary">Gönder</button>
        </form>
    </div>

    <!-- Ödeme Bildirimi -->
    <div class="border rounded p-3 mb-4" style="background:#e9f7ef;">
        <h4>Ödeme Yap</h4>
       <p>Ödeme için aşağıdaki IBAN’a havale/EFT yapın
   <strong style="color: darkred; font-size: 1.2em;">Alıcı ismi: Ali Altınsoy</strong>
</p>

        <div class="input-group mb-2">
            <input type="text" id="ibanInput" class="form-control" value="TR140001500158007286281178" readonly>
            <button class="btn btn-outline-secondary" type="button" onclick="copyIBAN()">Kopyala</button>
        </div>
        {% if user.is_authenticated %}
        <form method="post" action="{% url 'odeme_bildirim' %}">
            {% csrf_token %}
            <button type="submit" class="btn btn-success w-100">Ödeme Bildirimi Gönder</button>
        </form>
        {% else %}
        <p class="mt-2">Ödeme bildiriminde bulunmak için <a href="{% url 'login' %}?next={{ request.path }}">giriş yapın</a>.</p>
        {% endif %}
    </div>

    <!-- Örnek Sayfalar -->
    <div class="border rounded p-3 mb-4" style="background:#fef9e7;">
        <h4>Örnek Sayfalar</h4>
        <ul>
            <li><a href="{% url 'ornek1' %}">Örnek Sayfa 1</a></li>
            <li><a href="{% url 'darisüreler' %}">Örnek Sayfa 2</a></li>
            <li><a href="{% url 'bim5mad' %}">Örnek Sayfa 3</a></li>
        </ul>
    </div>

    <!-- Faydalı Linkler -->
    <div class="border rounded p-3 mb-4" style="background:#f2d7d5;">
        <h4>Faydalı Linkler</h4>
        <ul>
            <li><a href="https://www.adalet.gov.tr/" target="_blank">Adalet Bakanlığı</a></li>
            <li><a href="https://pgm.adalet.gov.tr/" target="_blank">Personel Genel Müdürlüğü</a></li>
            <li><a href="https://odsgm.meb.gov.tr/" target="_blank">Milli Eğitim Bakanlığı</a></li>
        </ul>
    </div>

</div>

<script>
// Chat işlevi
function getCookie(name) {
    let v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
    return v ? v.pop() : '';
}

const chatBox = document.getElementById('chat-box');
const chatForm = document.getElementById('chat-form');
const chatInput = document.getElementById('chat-input');

function fetchMessages() {
    fetch('/user/chat_api/')
    .then(r => r.json())
    .then(messages => {
        chatBox.innerHTML = '';
        if (!messages.length) chatBox.innerHTML = '<p><em>Merhaba! Sorularınızı buradan iletebilirsiniz.</em></p>';
        messages.forEach(msg => {
            const p = document.createElement('p');
            p.style.padding='5px'; p.style.margin='3px'; p.style.borderRadius='8px';
            if (msg.user === 'Admin') { p.style.backgroundColor='darkred'; p.style.color='white'; p.style.textAlign='right'; }
            else { p.style.backgroundColor='#f1f1f1'; p.style.color='black'; p.style.textAlign='left'; }
            p.innerHTML = `<strong>${msg.user || 'Ziyaretçi'}:</strong> ${msg.message} <small>(${msg.time})</small>`;
            chatBox.appendChild(p);
        });
        chatBox.scrollTop = chatBox.scrollHeight;
    });
}

chatForm.addEventListener('submit', e => {
    e.preventDefault();
    const text = chatInput.value.trim();
    if (!text) return;
    fetch('/user/chat_api/', {
        method:'POST',
        headers: {'X-CSRFToken': getCookie('csrftoken'),'Content-Type':'application/x-www-form-urlencoded'},
        body:`text=${encodeURIComponent(text)}&name=Ziyaretçi`
    }).then(r=>r.json()).then(d=>{ chatInput.value=''; fetchMessages(); });
});

fetchMessages();
setInterval(fetchMessages, 3000);

// IBAN kopyalama
function copyIBAN() {
    const copyText = document.getElementById("ibanInput");
    copyText.select(); copyText.setSelectionRange(0,99999);
    navigator.clipboard.writeText(copyText.value);
    alert("IBAN kopyalandı: " + copyText.value);
}
</script>

{% endblock %}
